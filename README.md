# Keycloack - AWS Identity Center SCIM Integration

Keycloak Event Listener provider and SCIM client to allow Keycloak users/groups to be provisioned to AWS IAM Identity Center.

## Description

This project implements a Keycloak event listener and a basic SCIM client that listens to Keycloak events related to user/group creation, modification and deletion. When it detects those events, it generates a SCIM request against an AWS IAM Identity Center instance to update user/group assignments. This allows you to enforce lifecycle management operations in AWS IAM Identity Center in response to lifecycle operations in your Keycloak IdP.

## Architecture

To keep the system as realtime as possible (create/modify/delete users/groups in AWS should occur as soon as possible when those operations are performed in KeyCloak), the system relies on events that are generated by KeyCloak for user/group lifecycle events. This is done by a custom EventListener SPI that is deployed in Keycloack as an additional event logging provider (scim-event-listener). The scim-event-listener listens for admin events as well as registers itself as an event handler for deletion transactions. Events that are received are then published to a RabbitMQ message queue where the events are then consumed by a Python program that performs the actual SCIM operations.

This architecture was designed to decouple application logic from the EventListener provider so that it doesn't need to be aware of the 3rd party applications (in this case AWS) that is being provisioned to from Keycloak.

## Getting Started

### Dependencies

* Python3.9 or greater
* Keycloak server instance (tested on v 23.0.4)
* RabbitMQ instance
* AWS IAM Identity Center

### Installing

For the beta release, installation is manual.

#### Installing the scim-event-listener
* Clone this repo on your server running Keycloak 23.0.4 or greater (tested on Amazon Linux 2023)
* Download the scim-event-listener from the releases link: https://github.com/wgoulet/scim-keycloak-bridge/releases/download/v0.0.1-beta/scim-event-listener.jar (or alternatively, build it from source)
* Copy scim-event-listener.jar to the /providers directory where Keycloak is installed (e.g. if keycloak is installed in /usr/local/, the path might be /usr/local/keycloak-23.0.4/providers)
* Activate the provider by executing the ```kc.sh build``` command.
* Restart the Keycloak instance.
* Log into Keycloak as an administrator. For each realm you want to enable the provider on, navigate to Realm settings, select Events, select the Event Listener tab and select 'scim-event-provider' to enable it.

#### Installing the scim_client_kc_aws.py script
* Create a service user that will run the script.
* From the location where the repo was cloned, create a virtualenv.
* Activate the virtualenv, then install the dependencies ```pip3 -install requirements.txt```
* Note the path to the virtualenv
* Execute the script with the virtualenv environment ```/path/to/virtualenv/bin/python scim_client_kc_aws.py```
* To run the script automatically, consider the approach described here: https://github.com/torfsen/python-systemd-tutorial/tree/master

### Usage

The SCIM client uses attributes associated with users and groups to determine if it should take action (provision/deprovision/change user/groups). To set a user or group up to be provisioned in AWS, add this attribute to the user/group in Keycloak:
```
awsenabled
```

and give it a value of 'true'. When the SCIM client receives an event from the SCIM Event Listener, it will check if this attribute is present and if it is, will create the usr/group in AWS and store the AWS ID for the user/group in a new attribute called 'awsid'.

Supported operations include:
- Removing user/groups from AWS by deleting the 'awsenabled' attribute
- Adding/removing AWS provisioned users from AWS provisioned groups
- Automatically removing users/groups provisioned to AWS when the users/groups are deleted from Keycloak.

### Executing program

* Create a virtualenv for the program
* Launch it with the python interpreter installed in the virtualenv
```
code blocks for commands
```

## Help

Any advise for common problems or issues.
```
command to run if program contains helper info
```

## Authors

Contributors names and contact info
Walter Goulet


## Version History

* 0.1
    * Initial Release

## License

This project is licensed under the MIT License - see the LICENSE.md file for details

## Acknowledgments
